<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üé¨ Adivina Qui√©n - El Casting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top center, #1a1d3d, #0c0e2c);
      color: white;
      text-align: center;
      padding: 20px;
    }

    h1 {
      font-size: 2.5em;
      color: #ec1c24;
      text-shadow: 2px 2px 5px black;
      letter-spacing: 2px;
      margin-bottom: 10px;
    }

    .tarjeta {
      background-color: #1f2140;
      padding: 30px;
      margin: 30px auto;
      border-radius: 15px;
      max-width: 550px;
      box-shadow: 0 0 20px rgba(236, 28, 36, 0.3);
      border: 2px solid #ec1c24;
      transition: transform 0.3s ease-in-out;
    }

    .tarjeta:hover {
      transform: scale(1.02);
    }

    p {
      font-size: 1.1em;
      margin: 8px 0;
    }

    select {
      padding: 10px;
      font-size: 16px;
      width: 85%;
      margin-top: 15px;
      border-radius: 6px;
      border: none;
    }

    button {
      padding: 12px 24px;
      margin-top: 20px;
      font-size: 16px;
      border: none;
      background-color: #ec1c24;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(236, 28, 36, 0.4);
    }

    #resultado {
      margin-top: 20px;
      font-weight: bold;
      font-size: 1.2em;
    }

    #puntaje {
      margin-top: 10px;
      color: lightgreen;
      font-weight: bold;
    }

    #timer {
      font-size: 1.2em;
      margin-top: 10px;
      color: #ffca28;
    }

    #advertencia {
      display: none;
      font-weight: bold;
      color: #ffeb3b;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>üé¨ Adivina Qui√©n - El Casting</h1>

  <div class="tarjeta">
    <div id="timer">‚è≥ Tiempo restante: 15:00</div>
    <div id="advertencia">‚ö†Ô∏è ¬°Quedan solo 2 minutos! Adivina r√°pido...</div>
    <div id="contenido"></div>

    <select id="respuesta">
      <option value="" disabled selected>üé≠ ¬øQui√©n crees que es?</option>
      </select>

    <br>
    <button onclick="verificar()">Responder</button>
    <div id="resultado"></div>
    <div id="puntaje">Puntaje: 0</div>
  </div>

  <script>
    // --- NUEVA L√ìGICA ---
    
    // 1. Guardamos a TODOS los participantes y luego elegimos 15 para jugar.
    const todosLosParticipantes = {{ participantes|tojson }};
    const participantesParaJugar = todosLosParticipantes.sort(() => 0.5 - Math.random()).slice(0, 15);

    let indiceActual = 0; // Para saber qu√© tarjeta mostrar
    let actual;
    let aciertos = 0;
    let puntaje = 0;
    let tiempoRestante = 900; // 15 minutos
    let temporizadorIntervalo;

    // Claves para generar las pistas de forma aleatoria.
    const frases_keys = [
      ["dato_curioso", "üß† Dato curioso"],
      ["pelicula_favorita", "üé¨ Pel√≠cula favorita"],
      ["prenda_imprescindible", "üëï Prenda imprescindible"],
      ["mejor_concierto", "üé§ Concierto"],
      ["pasion", "üé∂ Pasi√≥n"]
    ];

    function mostrarFrase() {
      // Si ya se adivinaron los 15, termina el juego.
      if (indiceActual >= participantesParaJugar.length) {
        finalizarJuego();
        return;
      }

      actual = participantesParaJugar[indiceActual];

      // --- Generaci√≥n din√°mica del men√∫ desplegable ---
      const nombreCorrecto = actual.nombre_completo;
      
      // Filtramos para obtener 14 nombres incorrectos al azar.
      const opcionesIncorrectas = todosLosParticipantes
        .filter(p => p.nombre_completo !== nombreCorrecto)
        .sort(() => 0.5 - Math.random())
        .slice(0, 14)
        .map(p => p.nombre_completo);

      // Creamos la lista final de 15, la barajamos y la mostramos.
      let opcionesFinales = [...opcionesIncorrectas, nombreCorrecto];
      opcionesFinales = opcionesFinales.sort(() => 0.5 - Math.random());
      
      const selectRespuesta = document.getElementById("respuesta");
      selectRespuesta.innerHTML = '<option value="" disabled selected>üé≠ ¬øQui√©n crees que es?</option>'; // Limpiamos y ponemos la opci√≥n por defecto
      opcionesFinales.forEach(nombre => {
        const option = document.createElement("option");
        option.value = nombre;
        option.textContent = nombre;
        selectRespuesta.appendChild(option);
      });
      // --- Fin de la generaci√≥n del men√∫ ---


      // Mostramos 3 pistas aleatorias para la persona actual.
      const seleccionadas = frases_keys.sort(() => 0.5 - Math.random()).slice(0, 3);
      let pistas = "";
      for (const [clave, etiqueta] of seleccionadas) {
        if(actual[clave]) {
          pistas += `<p><strong>${etiqueta}:</strong> ${actual[clave]}</p>`;
        }
      }

      document.getElementById("contenido").innerHTML = pistas;
      document.getElementById("resultado").innerText = "";
    }

    function verificar() {
      const seleccion = document.getElementById("respuesta").value;
      const correcto = actual.nombre_completo;

      if (seleccion === correcto) {
        document.getElementById("resultado").innerText = "‚úÖ ¬°Correcto!";
        aciertos++;
        puntaje += 10;
        document.getElementById("puntaje").innerText = `Puntaje: ${puntaje}`;
        
        // Pasamos a la siguiente persona
        indiceActual++;
        setTimeout(mostrarFrase, 1000);
      } else {
        document.getElementById("resultado").innerText = "‚ùå Incorrecto, intenta con otro nombre.";
        puntaje -= 10;
        document.getElementById("puntaje").innerText = `Puntaje: ${puntaje}`;
      }
    }

    function finalizarJuego() {
      clearInterval(temporizadorIntervalo);
      fetch('/adivina_finalizado', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ aciertos, puntaje })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message || data.error);
        window.location.href = "/ranking_adivina";
      });
    }

    function iniciarTemporizador() {
      const timer = document.getElementById("timer");
      const advertencia = document.getElementById("advertencia");

      temporizadorIntervalo = setInterval(() => {
        tiempoRestante--;
        const min = Math.floor(tiempoRestante / 60);
        const seg = tiempoRestante % 60;
        timer.innerText = `‚è≥ Tiempo restante: ${min.toString().padStart(2, '0')}:${seg.toString().padStart(2, '0')}`;

        if (tiempoRestante === 120) {
          advertencia.style.display = "block";
        }

        if (tiempoRestante <= 0) {
          clearInterval(temporizadorIntervalo);
          alert("‚è∞ ¬°Se acab√≥ el tiempo!");
          finalizarJuego();
        }
      }, 1000);
    }

    // Iniciar todo
    mostrarFrase();
    iniciarTemporizador();
  </script>

</body>
</html>