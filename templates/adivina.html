<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>üé¨ Adivina Qui√©n ‚Äì El Casting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{
      font-family:'Segoe UI',sans-serif;
      background:radial-gradient(circle at top center,#1a1d3d,#0c0e2c);
      color:#fff;text-align:center;padding:20px
    }
    h1{font-size:2.5em;color:#ec1c24;text-shadow:2px 2px 5px #000;letter-spacing:2px;margin-bottom:10px}
    .tarjeta{background:#1f2140;padding:30px;margin:30px auto;border-radius:15px;max-width:550px;
      box-shadow:0 0 20px rgba(236,28,36,.3);border:2px solid #ec1c24;transition:transform .3s}
    .tarjeta:hover{transform:scale(1.02)}
    p{font-size:1.1em;margin:8px 0}
    select{padding:10px;font-size:16px;width:85%;margin-top:15px;border-radius:6px;border:none}
    button{padding:12px 24px;margin-top:20px;font-size:16px;border:none;background:#ec1c24;color:#fff;
      border-radius:8px;cursor:pointer;box-shadow:0 0 10px rgba(236,28,36,.4)}
    #resultado{margin-top:20px;font-weight:bold;font-size:1.2em}
    #puntaje{margin-top:10px;color:lightgreen;font-weight:bold}
    #timer{font-size:1.2em;margin-top:10px;color:#ffca28}
    #advertencia{display:none;font-weight:bold;color:#ffeb3b;margin-top:10px}
  </style>
</head>
<body>
  <h1>üé¨ Adivina Qui√©n ‚Äì El Casting</h1>

  <div class="tarjeta">
    <div id="timer">‚è≥ Tiempo restante: 15:00</div>
    <div id="advertencia">‚ö†Ô∏è ¬°Quedan solo 2 minutos! Adivina r√°pido‚Ä¶</div>

    <div id="contenido"></div>

    <select id="respuesta">
      <option value="" disabled selected>üé≠ ¬øQui√©n crees que es?</option>
    </select>

    <br />
    <button onclick="verificar()">Responder</button>

    <div id="resultado"></div>
    <div id="puntaje">Puntaje: 0</div>
  </div>

  <script>
    /* ---------- DATOS Y CONFIG ---------- */
    const todosLosParticipantes = {{ participantes|tojson|safe }};

    // 15 nombres para la sesi√≥n
    const participantesParaJugar = todosLosParticipantes
      .sort(() => 0.5 - Math.random())
      .slice(0, 15);

    let nombresRestantes = participantesParaJugar.map(p => p.nombre_completo);

    let indiceActual   = 0;
    let actual         = null;
    let aciertos       = 0;
    let puntaje        = 0;
    let tiempoRestante = 900; // 15 min
    let temporizadorIntervalo;

    const pistas_keys = [
      ["dato_curioso",         "üß† Dato curioso"],
      ["pelicula_favorita",    "üé¨ Pel√≠cula favorita"],
      ["deporte_favorito",  "üèÄ Deporte favorito"],
      ["mejor_concierto",      "üé§ Concierto"],
      ["pasion",               "üé∂ Pasi√≥n"]
    ];

    /* ---------- RENDER ---------- */
    function mostrarFrase(){
      if (indiceActual >= participantesParaJugar.length){
        finalizarJuego();
        return;
      }

      actual = participantesParaJugar[indiceActual];
      const nombreCorrecto = actual.nombre_completo;

      // 14 nombres err√≥neos
      const opcionesIncorrectas = nombresRestantes
        .filter(n => n !== nombreCorrecto)
        .sort(() => 0.5 - Math.random())
        .slice(0, 14);

      const opcionesFinales = [...opcionesIncorrectas, nombreCorrecto]
        .sort(() => 0.5 - Math.random());

      const sel = document.getElementById("respuesta");
      sel.innerHTML =
        '<option value="" disabled selected>üé≠ ¬øQui√©n crees que es?</option>';
      opcionesFinales.forEach(n => {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        sel.appendChild(opt);
      });

      const pistas = pistas_keys
        .sort(() => 0.5 - Math.random())
        .slice(0, 3)
        .map(([k, label]) =>
          actual[k] ? `<p><strong>${label}:</strong> ${actual[k]}</p>` : ""
        )
        .join("");
      document.getElementById("contenido").innerHTML = pistas;
      document.getElementById("resultado").textContent = "";
    }

    /* ---------- VERIFICACI√ìN ---------- */
    function verificar(){
      const sel = document.getElementById("respuesta");
      const seleccion = sel.value;
      if(!seleccion) return;

      if(seleccion === actual.nombre_completo){
        document.getElementById("resultado").textContent = "‚úÖ ¬°Correcto!";
        aciertos++; puntaje += 10;
        nombresRestantes = nombresRestantes.filter(n => n !== seleccion);
        indiceActual++;
        document.getElementById("puntaje").textContent = `Puntaje: ${puntaje}`;
        setTimeout(mostrarFrase, 800);
      }else{
        document.getElementById("resultado").textContent =
          "‚ùå Incorrecto, intenta de nuevo.";
        puntaje -= 10;
        document.getElementById("puntaje").textContent = `Puntaje: ${puntaje}`;
      }
    }

    /* ---------- TEMPORIZADOR ---------- */
    function iniciarTemporizador(){
      const timer = document.getElementById("timer");
      const adv   = document.getElementById("advertencia");

      temporizadorIntervalo = setInterval(() => {
        tiempoRestante--;
        const m = String(Math.floor(tiempoRestante/60)).padStart(2,"0");
        const s = String(tiempoRestante%60).padStart(2,"0");
        timer.textContent = `‚è≥ Tiempo restante: ${m}:${s}`;

        if (tiempoRestante === 120) adv.style.display = "block";
        if (tiempoRestante <= 0){
          clearInterval(temporizadorIntervalo);
          alert("‚è∞ ¬°Se acab√≥ el tiempo!");
          finalizarJuego();
        }
      }, 1000);
    }

    /* ---------- FIN DE JUEGO ---------- */
    function finalizarJuego(){
      clearInterval(temporizadorIntervalo);
      fetch("/adivina_finalizado",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ aciertos, puntaje })
      })
      .then(r=>r.json())
      .then(d=>{
        alert(d.message || d.error);
        window.location.href = "/ranking_adivina";
      });
    }

    /* ---------- INICIO ---------- */
    mostrarFrase();
    iniciarTemporizador();
  </script>
</body>
</html>
